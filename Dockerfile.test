FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build
WORKDIR /src

# Copy everything
COPY . .

# Build and pack
RUN dotnet pack Opener/Opener.csproj -c Release -o /nupkg

# Install the tool from the local package
RUN dotnet tool install --global --add-source /nupkg com.chirravuris.opener

# Add tool to path
ENV PATH="/root/.dotnet/tools:${PATH}"

# Ensure we have PowerShell for the script
RUN apt-get update && apt-get install -y powershell || true

# Run integration tests using pwsh (installed in dotnet sdk image usually, or we use the shell one)
# Actually mcr.microsoft.com/dotnet/sdk:10.0 has pwsh? Let's check or just use the .sh for linux
# But since we want to debug the .ps1 failure, let's try to run it with pwsh.

CMD ["pwsh", "./tests/integration_test.ps1"]
