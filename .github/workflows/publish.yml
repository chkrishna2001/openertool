name: Publish to NuGet

on:
  push:
    branches:
      - main
    paths:
      - 'Opener/**'
      - '.github/workflows/**'
      - 'tests/**'

jobs:
  integration-tests:
    name: Integration Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Pack and Install Tool Locally
      shell: pwsh
      run: |
        dotnet pack Opener/Opener.csproj -c Release -o ./nupkg
        dotnet tool install --global --add-source ./nupkg com.chirravuris.opener
    
    - name: Add Tool to Path (Windows)
      if: runner.os == 'Windows'
      run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
    - name: Add Tool to Path (Linux/macOS)
      if: runner.os != 'Windows'
      run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Run Integration Tests
      shell: pwsh
      run: ./tests/integration_test.ps1

  publish:
    needs: integration-tests
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore and Test (Unit)
      run: |
        dotnet restore Opener.sln
        dotnet test Opener.sln --configuration Release --verbosity normal

    - name: Pack
      run: dotnet pack Opener.sln --configuration Release --output ${{ github.workspace }}/nupkgs

    - name: Push to NuGet
      run: |
        dotnet nuget push "${{ github.workspace }}\nupkgs\*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
